<!--created scheduled outoftime started neverstarted success fail-->
<% count_visits = Visit.where({:policy_id => policy_id,
                               :policy_type => policy_type,
                               :state => "created"}).count
%>
<%= link_to "Created (#{count_visits})",
            visits_path({:execution_mode => execution_mode, :policy_id => policy_id,
                         :policy_type => policy_type,
                         :state => "created"}),
            remote: true,
            class: "btn btn-sm btn-default"
%>
<% if state == "created" and count_visits > 0 %>
    <%=
        link_to content_tag(:span, "", class: "glyphicon glyphicon-play"),
                publish_all_path({:policy_id => policy_id,
                                  :policy_type => policy_type,
                                  :state => "created"}),
                remote: true,
                data: {confirm: 'Are you sure?'}

    %>
    <%=
        link_to content_tag(:span, "", class: "glyphicon glyphicon-trash"),
                delete_all_by_state_path({:policy_id => policy_id,
                                          :policy_type => policy_type,
                                          :state => "created"}),
                remote: true,
                data: {confirm: 'Are you sure?'}

    %>
<% end %>
<% count_visits = Visit.where({:policy_id => policy_id,
                               :policy_type => policy_type,
                               :state => "scheduled"}).count
%>
<%= link_to "Scheduled (#{count_visits})",
            visits_path({:execution_mode => execution_mode, :policy_id => policy_id,
                         :policy_type => policy_type,
                         :state => "scheduled"}),
            remote: true,
            class: "btn btn-sm btn-info" %>
<%= if state == "scheduled" and count_visits > 0
      link_to content_tag(:span, "", class: "glyphicon glyphicon-trash"),
              delete_all_by_state_path({:policy_id => policy_id,
                                        :policy_type => policy_type,
                                        :state => "scheduled"}),
              remote: true,
              data: {confirm: 'Are you sure?'}
    end
%>
<% count_visits = Visit.where({:policy_id => policy_id,
                               :policy_type => policy_type,
                               :state => "published"}).count
%>
<%= link_to "Published (#{count_visits})",
            visits_path({:execution_mode => execution_mode, :policy_id => policy_id,
                         :policy_type => policy_type,
                         :state => "published"}),
            remote: true,
            class: "btn btn-sm btn-primary" %>
<%= if state == "published" and count_visits > 0
      link_to content_tag(:span, "", class: "glyphicon glyphicon-trash"),
              delete_all_by_state_path({:policy_id => policy_id,
                                        :policy_type => policy_type,
                                        :state => "published"}),
              remote: true,
              data: {confirm: 'Are you sure?'}
    end
%>
<% count_visits = Visit.where({:policy_id => policy_id,
                               :policy_type => policy_type,
                               :state => "started"}).count
%>
<%= link_to "Started (#{count_visits})",
            visits_path({:execution_mode => execution_mode, :policy_id => policy_id,
                         :policy_type => policy_type,
                         :state => "started"}),
            remote: true,
            class: "btn btn-sm btn-primary" %>
<%= if state == "started" and count_visits > 0
      link_to content_tag(:span, "", class: "glyphicon glyphicon-trash"),
              delete_all_by_state_path({:policy_id => policy_id,
                                        :policy_type => policy_type,
                                        :state => "started"}),
              remote: true,
              data: {confirm: 'Are you sure?'}
    end
%>
<% count_visits = Visit.where({:policy_id => policy_id,
                               :policy_type => policy_type,
                               :state => "success"}).count
%>
<%= link_to "Success (#{count_visits})",
            visits_path({:execution_mode => execution_mode, :policy_id => policy_id,
                         :policy_type => policy_type,
                         :state => "success"}),
            remote: true,
            class: "btn btn-sm btn-success" %>
<%= if state == "success" and count_visits > 0
      link_to content_tag(:span, "", class: "glyphicon glyphicon-trash"),
              delete_all_by_state_path({:policy_id => policy_id,
                                        :policy_type => policy_type,
                                        :state => "success"}),
              remote: true,
              data: {confirm: 'Are you sure?'}
    end
%>
<% count_visits = Visit.where({:policy_id => policy_id,
                               :policy_type => policy_type,
                               :state => "fail"}).count
%>
<%= link_to "Fail (#{count_visits})",
            visits_path({:execution_mode => execution_mode, :policy_id => policy_id,
                         :policy_type => policy_type,
                         :state => "fail"}),
            remote: true,
            class: "btn btn-sm btn-danger" %>
<%= if state == "fail" and count_visits > 0
      link_to content_tag(:span, "", class: "glyphicon glyphicon-trash"),
              delete_all_by_state_path({:policy_id => policy_id,
                                        :policy_type => policy_type,
                                        :state => "fail"}),
              remote: true,
              data: {confirm: 'Are you sure?'}
    end
%>
<% count_visits = Visit.where({:policy_id => policy_id,
                               :policy_type => policy_type,
                               :state => "outoftime"}).count
%>
<%= link_to "Out of Time (#{count_visits})",
            visits_path({:execution_mode => execution_mode, :policy_id => policy_id,
                         :policy_type => policy_type,
                         :state => "outoftime"}),
            remote: true,
            class: "btn btn-sm btn-warning" %>
<%= if state == "outoftime" and count_visits > 0
      link_to content_tag(:span, "", class: "glyphicon glyphicon-trash"),
              delete_all_by_state_path({:policy_id => policy_id,
                                        :policy_type => policy_type,
                                        :state => "outoftime"}),
              remote: true,
              data: {confirm: 'Are you sure?'}
    end
%>
<% count_visits = Visit.where({:policy_id => policy_id,
                               :policy_type => policy_type,
                               :state => "overttl"}).count
%>
<%= link_to "Over Time to Live (#{count_visits})",
            visits_path({:execution_mode => execution_mode, :policy_id => policy_id,
                         :policy_type => policy_type,
                         :state => "overttl"}),
            remote: true,
            class: "btn btn-sm btn-warning" %>
<%= if state == "overttl" and count_visits > 0
      link_to content_tag(:span, "", class: "glyphicon glyphicon-trash"),
              delete_all_by_state_path({:policy_id => policy_id,
                                        :policy_type => policy_type,
                                        :state => "overttl"}),
              remote: true,
              data: {confirm: 'Are you sure?'}
    end
%>
<% count_visits = Visit.where({:policy_id => policy_id,
                               :policy_type => policy_type,
                               :state => "neverstarted"}).count
%>
<%= link_to "Never Started (#{count_visits})",
            visits_path({:execution_mode => execution_mode, :policy_id => policy_id,
                         :policy_type => policy_type,
                         :state => "neverstarted"}),
            remote: true,
            class: "btn btn-sm btn-warning" %>

<%= if state == "neverstarted" and count_visits > 0
      link_to content_tag(:span, "", class: "glyphicon glyphicon-trash"),
              delete_all_by_state_path({:policy_id => policy_id,
                                        :policy_type => policy_type,
                                        :state => "neverstarted"}),
              remote: true,
              data: {confirm: 'Are you sure?'}
    end
%>


<table class="table">
  <thead class="header-table">
  <tr>
    <th class="text-center">State</th>
    <% if ["created", "scheduled", "published", "success", "fail", "outoftime", "overttl", "neverstarted"].include?(state) %>
        <th class="text-center">Plan time</th>
    <% end %>
    <% if ["started", "success", "fail", "overttl"].include?(state) %>
        <th class="text-center">Start time</th>
    <% end %>
    <% if ["success", "fail", "overttl"].include?(state) %>
        <th class="text-left">End time</th>
    <% end %>
    <% if ["started", "success", "fail", "overttl"].include?(state) %>
        <th class="text-left">Delay</th>
    <% end %>
    <% if ["started", "success", "fail", "overttl"].include?(state) %>
        <th class="text-left">Actions</th>
    <% end %>
    <% if ["fail"].include?(state) %>
        <th class="text-left">Reason</th>
    <% end %>
    <th class="text-left">Os</th>
    <th class="text-left">Browser
      <%= link_to content_tag(:span, "", class: "glyphicon glyphicon-arrow-up"),
                  order_by_visit_path({:policy_id => policy_id,
                                       :policy_type => policy_type,
                                       :state => state,
                                       :criteria => :browser_name,
                                       :way => :asc}),
                  remote: true
      %>
      <%= link_to content_tag(:span, "", class: "glyphicon glyphicon-arrow-down"),
                  order_by_visit_path({:policy_id => policy_id,
                                       :policy_type => policy_type,
                                       :state => state,
                                       :criteria => :browser_name,
                                       :way => :desc}),
                  remote: true
      %>
    </th>
    <th class="text-center">Referrer</th>
    <th class="text-center">Advert</th>
    <% if ["started", "success", "fail", "overttl"].include?(state) %>
        <th class="text-center">Geolocation
          <%= link_to content_tag(:span, "", class: "glyphicon glyphicon-arrow-up"),
                      order_by_visit_path({:policy_id => policy_id,
                                           :policy_type => policy_type,
                                           :state => state,
                                           :criteria => :ip_geo_proxy,
                                           :way => :asc}),
                      remote: true
          %>
          <%= link_to content_tag(:span, "", class: "glyphicon glyphicon-arrow-down"),
                      order_by_visit_path({:policy_id => policy_id,
                                           :policy_type => policy_type,
                                           :state => state,
                                           :criteria => :ip_geo_proxy,
                                           :way => :desc}),
                      remote: true
          %></th>
        <th>Country</th>

    <% end %>

  </tr>

  </thead>


  <tbody>
  <% prev_date = nil
     count_visit_per_day = 0
     count_adword_click = 0

  %>
  <% visits.each do |visit| %>
      <% case visit.state
           when "created"
             color_state = "label label-default"
           when "scheduled"
             color_state = "label label-info"
           when "outoftime", "overttl", "neverstarted"
             color_state = "label label-warning"
           when "started", "published"
             color_state = "label label-primary"
           when "success"
             color_state = "label label-success"
           when "fail"
             color_state = "label label-danger"
           else
             color_state = "label label-default"
         end %>
      <!--affiche la premiere ligne du tableau -->
      <% if prev_date.nil?
           prev_date = visit.plan_time.to_date

      %>
          <tr class="info">
            <td colspan="20"><span class="label label-info"><%= visit.plan_time.to_date %></span></td>
          </tr>
          <% count_visit_per_day += 1
             count_adword_click += (visit.actions.index("F").nil? ? 0 : visit.actions.index("F") + 1 <= visit.count_browsed_page) ? 1 : 0
          %>
          <!--affiche un changement de jour-->
      <% elsif prev_date != visit.plan_time.to_date %>

          <tr class="info">
            <td colspan="20"><span class="label label-info">Visits/day</span>
              <span class="badge"><%= count_visit_per_day %> </span>
              <% if ["success", "fail", "overttl"].include?(state) %>
                  <span class="label label-info">Total Adwords click</span>
                  <span class="badge"><%= count_adword_click %></span>
              <% end %>
            </td>
          </tr>
          <tr class="info">
            <td colspan="20"><span class="label label-info"><%= visit.plan_time.to_date %></span></td>
          </tr>
          <%
             prev_date = visit.plan_time.to_date
             count_visit_per_day = 1
          %>
          <!--affiche une ligne de visit-->
      <% else
           count_visit_per_day += 1
           count_adword_click += (visit.actions.index("F").nil? ? 0 : visit.actions.index("F") + 1 <= visit.count_browsed_page) ? 1 : 0
      %>
      <% end %>


      <td class="text-center">
        <%= count_visit_per_day %>

        <span class="<%= color_state %>"><%= visit.state %></span>
        <%= if visit.state == "created"
              link_to content_tag(:span, "", class: "glyphicon glyphicon-play"),
                      publish_visit_path({:visit_id => visit.id_visit, :policy_id => visit.policy_id,
                                          :policy_type => policy_type,
                                          :state => visit.state}),
                      remote: true,
                      data: {confirm: 'Are you sure?'}
            elsif ["scheduled", "published", "started"].include?(visit.state)
              link_to content_tag(:span, "", class: "glyphicon glyphicon-refresh"),
                      refresh_visit_path({:visit_id => visit.id_visit, :policy_id => visit.policy_id,
                                          :policy_type => policy_type,
                                          :state => visit.state}),
                      remote: true
            end %>
        <%= link_to content_tag(:span, "", class: "glyphicon glyphicon-trash"),
                    delete_visit_path({:visit_id => visit.id_visit, :policy_id => visit.policy_id,
                                       :policy_type => policy_type,
                                       :state => visit.state}),
                    remote: true,
                    data: {confirm: 'Are you sure?'}
        %>
      </td>

      <% if ["created", "scheduled", "published", "success", "fail", "outoftime", "overttl", "neverstarted"].include?(state) %>
          <td class="text-center"><%= visit.plan_time.nil? ? "unknown" : visit.plan_time.localtime.to_formatted_s(:hour_min_sec) %></td>
      <% end %>
      <% if ["started", "success", "fail", "overttl"].include?(state) %>
          <td class="text-center"><%= visit.start_time.nil? ? "unknown" : visit.start_time.localtime.to_formatted_s(:hour_min_sec) %></td>
      <% end %>
      <% if ["success", "fail", "overttl"].include?(state) %>
          <td class="text-center"><%= visit.end_time.localtime.to_formatted_s(:hour_min_sec) %></td>
      <% end %>
      <% if ["started", "success", "fail", "overttl"].include?(state) %>
          <td class="text-left"><%= distance_of_time_in_words(visit.start_time, visit.start_time.nil? ? 0 : visit.end_time || Time.now, include_seconds: true) %></td>
      <% end %>
      <% if ["started", "success", "fail", "overttl"].include?(state) %>
          <td class="text-left">
            <% visit.actions.each_with_index { |action, i| %>
                <% if i + 1 <= visit.count_browsed_page %>
                    <span class="label label-success"><%= action %> </span>
                <% else %>
                    <!-- action F == click_on_advert-->
                    <% if action == "F" %>
                        <span class="label label-warning"><%= action %> </span>
                    <% else %>
                        <span class="label label-default"><%= action %> </span>
                    <% end %>
                <% end %>
            <% } %>
          </td>
      <% end %>
      <% if ["fail"].include?(state) %>
          <td class="text-left"><%= visit.reason %></td>
      <% end %>
      <td class="text-left"><%= visit.operating_system_name %>/<%= visit.operating_system_version %></td>
      <td class="text-left"><%= visit.browser_name %>/<%= visit.browser_version %></td>
      <td class="text-center"><%= visit.referrer %></td>
      <td class="text-center"><%= visit.advert %></td>
      <% if ["started", "success", "fail", "overttl"].include?(state) %>
          <td class="text-center"><%= visit.ip_geo_proxy %> </td>
          <td class="text-center"><%= visit.country_geo_proxy %> </td>
      <% end %>
      </tr>
  <% end %>
  <tr class="info">
    <td colspan="20"><span class="label label-info">Visits/day</span>
      <span class="badge"><%= count_visit_per_day %></span>
      <% if ["success", "fail", "overttl"].include?(state) %>

          <span class="label label-success">Total Adwords click</span>
          <span class="badge"><%= count_adword_click %></span>

      <% end %>
    </td>
  </tr>
  </tbody>
</table>