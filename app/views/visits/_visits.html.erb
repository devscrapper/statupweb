<!--created scheduled outoftime started neverstarted success fail-->
<% count_visits = Visit.where({:policy_id => policy_id,
                               :policy_type => policy_type,
                               :state => "created"}).count
%>
<%= link_to "Created (#{count_visits})",
            visits_path({:execution_mode => execution_mode, :policy_id => policy_id,
                         :policy_type => policy_type,
                         :state => "created"}),
            remote: true,
            class: "btn btn-sm btn-default"
%>
<% if state == "created" and count_visits > 0 %>
    <%=
        link_to content_tag(:span, "", class: "glyphicon glyphicon-play"),
                publish_all_path({:policy_id => policy_id,
                                  :policy_type => policy_type,
                                  :state => "created"}),
                remote: true,
                data: {confirm: 'Are you sure?'}

    %>
    <%=
        link_to content_tag(:span, "", class: "glyphicon glyphicon-trash"),
                delete_all_by_state_path({:policy_id => policy_id,
                                          :policy_type => policy_type,
                                          :state => "created"}),
                remote: true,
                data: {confirm: 'Are you sure?'}

    %>
<% end %>
<% count_visits = Visit.where({:policy_id => policy_id,
                               :policy_type => policy_type,
                               :state => "scheduled"}).count
%>
<%= link_to "Scheduled (#{count_visits})",
            visits_path({:execution_mode => execution_mode, :policy_id => policy_id,
                         :policy_type => policy_type,
                         :state => "scheduled"}),
            remote: true,
            class: "btn btn-sm btn-info" %>
<%= if state == "scheduled" and count_visits > 0
      link_to content_tag(:span, "", class: "glyphicon glyphicon-trash"),
              delete_all_by_state_path({:policy_id => policy_id,
                                        :policy_type => policy_type,
                                        :state => "scheduled"}),
              remote: true,
              data: {confirm: 'Are you sure?'}
    end
%>
<% count_visits = Visit.where({:policy_id => policy_id,
                               :policy_type => policy_type,
                               :state => "published"}).count
%>
<%= link_to "Published (#{count_visits})",
            visits_path({:execution_mode => execution_mode, :policy_id => policy_id,
                         :policy_type => policy_type,
                         :state => "published"}),
            remote: true,
            class: "btn btn-sm btn-primary" %>
<%= if state == "published" and count_visits > 0
      link_to content_tag(:span, "", class: "glyphicon glyphicon-trash"),
              delete_all_by_state_path({:policy_id => policy_id,
                                        :policy_type => policy_type,
                                        :state => "published"}),
              remote: true,
              data: {confirm: 'Are you sure?'}
    end
%>
<% count_visits = Visit.where({:policy_id => policy_id,
                               :policy_type => policy_type,
                               :state => "started"}).count
%>
<%= link_to "Started (#{count_visits})",
            visits_path({:execution_mode => execution_mode, :policy_id => policy_id,
                         :policy_type => policy_type,
                         :state => "started"}),
            remote: true,
            class: "btn btn-sm btn-primary" %>
<%= if state == "started" and count_visits > 0
      link_to content_tag(:span, "", class: "glyphicon glyphicon-trash"),
              delete_all_by_state_path({:policy_id => policy_id,
                                        :policy_type => policy_type,
                                        :state => "started"}),
              remote: true,
              data: {confirm: 'Are you sure?'}
    end
%>
<% count_visits = Visit.where({:policy_id => policy_id,
                               :policy_type => policy_type,
                               :state => "success"}).count
%>
<%= link_to "Success (#{count_visits})",
            visits_path({:execution_mode => execution_mode, :policy_id => policy_id,
                         :policy_type => policy_type,
                         :state => "success"}),
            remote: true,
            class: "btn btn-sm btn-success" %>
<%= if state == "success" and count_visits > 0
      link_to content_tag(:span, "", class: "glyphicon glyphicon-trash"),
              delete_all_by_state_path({:policy_id => policy_id,
                                        :policy_type => policy_type,
                                        :state => "success"}),
              remote: true,
              data: {confirm: 'Are you sure?'}
    end
%>
<% count_visits = Visit.where({:policy_id => policy_id,
                               :policy_type => policy_type,
                               :state => "fail"}).count
%>
<%= link_to "Fail (#{count_visits})",
            visits_path({:execution_mode => execution_mode, :policy_id => policy_id,
                         :policy_type => policy_type,
                         :state => "fail"}),
            remote: true,
            class: "btn btn-sm btn-danger" %>
<%= if state == "fail" and count_visits > 0
      link_to content_tag(:span, "", class: "glyphicon glyphicon-trash"),
              delete_all_by_state_path({:policy_id => policy_id,
                                        :policy_type => policy_type,
                                        :state => "fail"}),
              remote: true,
              data: {confirm: 'Are you sure?'}
    end
%>

<% count_visits = Visit.where({:policy_id => policy_id,
                               :policy_type => policy_type,
                               :state => "advertnotfound"}).count
%>

<%= link_to "Advert not found (#{count_visits})",
            visits_path({:execution_mode => execution_mode, :policy_id => policy_id,
                         :policy_type => policy_type,
                         :state => "advertnotfound"}),
            remote: true,
            class: "btn btn-sm btn-danger" %>

<%= if state == "advertnotfound" and count_visits > 0
      link_to content_tag(:span, "", class: "glyphicon glyphicon-trash"),
              delete_all_by_state_path({:policy_id => policy_id,
                                        :policy_type => policy_type,
                                        :state => "fail"}),
              remote: true,
              data: {confirm: 'Are you sure?'}
    end
%>
<% count_visits = Visit.where({:policy_id => policy_id,
                               :policy_type => policy_type,
                               :state => "outoftime"}).count
%>
<%= link_to "Out of Time (#{count_visits})",
            visits_path({:execution_mode => execution_mode, :policy_id => policy_id,
                         :policy_type => policy_type,
                         :state => "outoftime"}),
            remote: true,
            class: "btn btn-sm btn-warning" %>
<%= if state == "outoftime" and count_visits > 0
      link_to content_tag(:span, "", class: "glyphicon glyphicon-trash"),
              delete_all_by_state_path({:policy_id => policy_id,
                                        :policy_type => policy_type,
                                        :state => "outoftime"}),
              remote: true,
              data: {confirm: 'Are you sure?'}
    end
%>
<% count_visits = Visit.where({:policy_id => policy_id,
                               :policy_type => policy_type,
                               :state => "overttl"}).count
%>
<%= link_to "Over Time to Live (#{count_visits})",
            visits_path({:execution_mode => execution_mode, :policy_id => policy_id,
                         :policy_type => policy_type,
                         :state => "overttl"}),
            remote: true,
            class: "btn btn-sm btn-warning" %>
<%= if state == "overttl" and count_visits > 0
      link_to content_tag(:span, "", class: "glyphicon glyphicon-trash"),
              delete_all_by_state_path({:policy_id => policy_id,
                                        :policy_type => policy_type,
                                        :state => "overttl"}),
              remote: true,
              data: {confirm: 'Are you sure?'}
    end
%>
<% count_visits = Visit.where({:policy_id => policy_id,
                               :policy_type => policy_type,
                               :state => "neverstarted"}).count
%>
<%= link_to "Never Started (#{count_visits})",
            visits_path({:execution_mode => execution_mode, :policy_id => policy_id,
                         :policy_type => policy_type,
                         :state => "neverstarted"}),
            remote: true,
            class: "btn btn-sm btn-warning" %>

<%= if state == "neverstarted" and count_visits > 0
      link_to content_tag(:span, "", class: "glyphicon glyphicon-trash"),
              delete_all_by_state_path({:policy_id => policy_id,
                                        :policy_type => policy_type,
                                        :state => "neverstarted"}),
              remote: true,
              data: {confirm: 'Are you sure?'}
    end
%>


<table class="table">
  <thead class="header-table">
  <tr>
    <th class="text-center">State</th>
    <th class="text-center">id</th>
    <% if ["created", "scheduled", "published", "success", "fail", "advertnotfound", "outoftime", "overttl", "neverstarted"].include?(state) %>
        <th class="text-center">Plan time</th>
    <% end %>
    <% if ["started", "success", "fail", "advertnotfound", "overttl"].include?(state) %>
        <th class="text-center">Start time</th>
    <% end %>
    <% if ["success", "fail", "advertnotfound", "overttl"].include?(state) %>
        <th class="text-left">End time</th>
    <% end %>
    <% if ["started", "success", "fail", "advertnotfound", "overttl"].include?(state) %>
        <th class="text-left">Delay</th>
    <% end %>
    <% if ["started", "success", "fail", "advertnotfound", "overttl"].include?(state) %>
        <th class="text-left">Actions</th>
    <% end %>
    <% if ["started", "success", "fail", "advertnotfound", "overttl"].include?(state) %>
        <th class="text-left">Captchas</th>
    <% end %>
    <% if ["fail", "advertnotfound"].include?(state) %>
        <th class="text-left">Reason</th>
    <% end %>
    <th class="text-left">Os</th>
    <th class="text-left">Browser
      <%= link_to content_tag(:span, "", class: "glyphicon glyphicon-arrow-up"),
                  order_by_visit_path({:policy_id => policy_id,
                                       :policy_type => policy_type,
                                       :state => state,
                                       :criteria => :browser_name,
                                       :way => :asc}),
                  remote: true
      %>
      <%= link_to content_tag(:span, "", class: "glyphicon glyphicon-arrow-down"),
                  order_by_visit_path({:policy_id => policy_id,
                                       :policy_type => policy_type,
                                       :state => state,
                                       :criteria => :browser_name,
                                       :way => :desc}),
                  remote: true
      %>
    </th>
    <th class="text-center">Referrer</th>
    <% if ["SeaAttack"].include?(policy_type) %>
        <th class="text-left">Keywords
          <%= link_to content_tag(:span, "", class: "glyphicon glyphicon-arrow-up"),
                      order_by_visit_path({:policy_id => policy_id,
                                           :policy_type => policy_type,
                                           :state => state,
                                           :criteria => :keywords,
                                           :way => :asc}),
                      remote: true
          %>
          <%= link_to content_tag(:span, "", class: "glyphicon glyphicon-arrow-down"),
                      order_by_visit_path({:policy_id => policy_id,
                                           :policy_type => policy_type,
                                           :state => state,
                                           :criteria => :keywords,
                                           :way => :desc}),
                      remote: true
          %>
        </th>
    <% end %>
    <th class="text-center">Advert</th>
    <% if ["started", "success", "fail", "advertnotfound", "overttl"].include?(state) %>
        <th class="text-center">Geolocation
          <%= link_to content_tag(:span, "", class: "glyphicon glyphicon-arrow-up"),
                      order_by_visit_path({:policy_id => policy_id,
                                           :policy_type => policy_type,
                                           :state => state,
                                           :criteria => :ip_geo_proxy,
                                           :way => :asc}),
                      remote: true
          %>
          <%= link_to content_tag(:span, "", class: "glyphicon glyphicon-arrow-down"),
                      order_by_visit_path({:policy_id => policy_id,
                                           :policy_type => policy_type,
                                           :state => state,
                                           :criteria => :ip_geo_proxy,
                                           :way => :desc}),
                      remote: true
          %></th>
        <th>Country</th>

    <% end %>

  </tr>

  </thead>


  <tbody>
  <% prev_date = nil
     count_visit_per_day = 0
     count_adword_click = 0
     count_advert_tracking = 0
     count_captcha_submitting = 0

  %>
  <% visits.each do |visit| %>
      <% case visit.state
           when "created"
             color_state = "label label-default"
           when "scheduled"
             color_state = "label label-info"
           when "outoftime", "overttl", "neverstarted"
             color_state = "label label-warning"
           when "started", "published"
             color_state = "label label-primary"
           when "success"
             color_state = "label label-success"
           when "fail"
             color_state = "label label-danger"
           when "advertnotfound"
             color_state = "label label-danger"
           else
             color_state = "label label-default"
         end %>
      <!--affiche la premiere ligne du tableau -->
      <% if prev_date.nil?
           prev_date = visit.plan_time.to_date

      %>
          <tr class="info">
            <td colspan="20"><span class="label label-info"><%= visit.plan_time.to_date %></span></td>
          </tr>
          <% count_visit_per_day += 1
             count_adword_click += (visit.actions.index("F").nil? ? 0 : (visit.actions.index("F") + 1 <= visit.count_browsed_page) ? 1 : 0)
             count_advert_tracking += visit.reason == "advert tracking" ? 1 : 0
             count_captcha_submitting += visit.reason == "captcha submitting" ? 1 : 0
          %>

          <!--affiche un changement de jour-->
      <% elsif prev_date != visit.plan_time.to_date %>

          <tr class="info">
            <td colspan="20"><span class="label label-info">Visits/day</span>
              <span class="badge"><%= count_visit_per_day %> </span>
              <% if ["advertnotfound"].include?(state) %>
                  <span class="label label-success">Total adwords not found</span>
                  <span class="badge"><%= count_advert_tracking %></span>
                  <span class="label label-success">Ratio Success</span>
                                    <span class="badge"><%= count_visit_per_day == 0 ? 0 : ((count_adword_click + count_advert_tracking) * 100 / Visit.plan_today(prev_date).count).to_i %>
                                      %</span>
              <% end %>
              <% if ["success", "fail", "overttl"].include?(state) %>
                  <span class="label label-info">Total Adwords click</span>
                  <span class="badge"><%= count_adword_click %></span>
                  <span class="label label-success">Ratio Success</span>
                  <span class="badge"><%= count_visit_per_day == 0 ? 0 : ((count_adword_click + count_advert_tracking) * 100 / Visit.plan_today(prev_date).count).to_i %>
                    %</span>
                  <span class="label label-danger">Total Captcha Submitting</span>
                  <span class="badge"><%= count_captcha_submitting %></span>


              <% end %>
            </td>
          </tr>
          <tr class="info">
            <td colspan="20"><span class="label label-info"><%= visit.plan_time.to_date %></span></td>
          </tr>
          <%
             prev_date = visit.plan_time.to_date
             count_visit_per_day = 1
             count_adword_click = 0
             count_advert_tracking = 0
             count_captcha_submitting = 0
          %>
          <!--affiche une ligne de visit-->
      <% else
           count_visit_per_day += 1
           count_adword_click += (visit.actions.index("F").nil? ? 0 : (visit.actions.index("F") + 1 <= visit.count_browsed_page) ? 1 : 0)
           count_advert_tracking += visit.reason == "advert tracking" ? 1 : 0
           count_captcha_submitting += visit.reason == "captcha submitting" ? 1 : 0
      %>
      <% end %>


      <td class="text-center">
        <%= count_visit_per_day %>

        <span class="<%= color_state %>"><%= visit.state %></span>
        <%= if visit.state == "created"
              link_to content_tag(:span, "", class: "glyphicon glyphicon-play"),
                      publish_visit_path({:visit_id => visit.id_visit, :policy_id => visit.policy_id,
                                          :policy_type => policy_type,
                                          :state => visit.state}),
                      remote: true,
                      data: {confirm: 'Are you sure?'}
            end %>
        <%= if ["fail", "advertnotfound"].include?(state)
              link_to content_tag(:span, "", class: "glyphicon glyphicon-export"),
                      visit_log_path({:visit_id => visit.id})
            end %>
        <%= link_to content_tag(:span, "", class: "glyphicon glyphicon-trash"),
                    delete_visit_path({:visit_id => visit.id_visit, :policy_id => visit.policy_id,
                                       :policy_type => policy_type,
                                       :state => visit.state}),
                    remote: true,
                    data: {confirm: 'Are you sure?'}
        %>

      </td>
      <td><%= visit.id_visit %></td>
      <% if ["created", "scheduled", "published", "success", "fail", "outoftime", "overttl", "neverstarted"].include?(state) %>
          <td class="text-center"><%= visit.plan_time.nil? ? "unknown" : visit.plan_time.localtime.to_formatted_s(:hour_min_sec) %></td>
      <% end %>
      <% if ["started", "success", "fail", "neverstarted", "overttl"].include?(state) %>
          <td class="text-center"><%= visit.start_time.nil? ? "unknown" : visit.start_time.localtime.to_formatted_s(:hour_min_sec) %></td>
      <% end %>
      <% if ["success", "fail", "neverstarted", "overttl"].include?(state) %>
          <td class="text-center"><%= visit.end_time.localtime.to_formatted_s(:hour_min_sec) %></td>
      <% end %>
      <% if ["started", "success", "fail", "neverstarted", "overttl"].include?(state) %>
          <td class="text-left"><%= visit.start_time.nil? ?
                                            "unknown" :
                                            distance_of_time_in_words(visit.start_time, visit.start_time.nil? ?
                                                                                              0 :
                                                                                              visit.end_time || Time.now, include_seconds: true) %></td>
      <% end %>
      <% if ["started", "success", "fail", "neverstarted", "overttl"].include?(state) %>
          <td class="text-left">
            <% visit.actions.each_with_index { |action, i| %>
                <% if i + 1 <= visit.count_browsed_page
                     class_name = "label label-success"
                   else
                     # action F == click_on_advert
                     case action
                       when "F"
                         class_name = "label label-warning"
                       when "3"
                         class_name = "label label-danger"
                       when "H"
                         class_name = "label label-info"
                       else
                         class_name = "label label-default"
                     end
                   end %>

                <%= if !visit.pages[i].nil? and visit.pages[i].has_image_file?
                      link_to action,
                              visit_pages_path({:visit_id => visit.id, :id => visit.pages[i].id}),
                              class: class_name
                    else
                      content_tag(:span, action, class: class_name)

                    end %>
            <% } %>
          </td>
          <td class="text-left">
            <% visit.captchas.each { |captcha| %>
                <%= if captcha.has_image_file?
                      link_to captcha.text,
                              visit_captchas_path({:visit_id => visit.id, :id => captcha.id}),
                              class: "label label-warning"
                    else
                      content_tag(:span, captcha.text, class: "label label-danger")

                    end %>
            <% } %>
          </td>
      <% end %>
      <% if ["fail", "neverstarted"].include?(state) %>
          <td class="text-left">
            <% case visit.reason %>
            <% when "advert tracking" %>
                <span class="label label-success"><%= visit.reason %> </span>
            <% when "captcha submitting" %>
                <span class="label label-danger"><%= visit.reason %> </span>
            <% else %>
                <%= visit.reason %>
            <% end %>

          </td>
      <% end %>
      <td class="text-left"><%= visit.operating_system_name %>/<%= visit.operating_system_version %></td>
      <td class="text-left"><%= visit.browser_name %>/<%= visit.browser_version %></td>
      <td class="text-center"><%= visit.referrer %></td>
      <% if ["SeaAttack"].include?(policy_type) %>
          <td class="text-left"><%= visit.keywords %></td>
      <% end %>
      <td class="text-center"><%= visit.advert %></td>
      <% if ["started", "success", "fail", "neverstarted", "overttl"].include?(state) %>
          <td class="text-center"><%= visit.ip_geo_proxy %> </td>
          <td class="text-center"><%= visit.country_geo_proxy %> </td>
      <% end %>
      </tr>
  <% end %>
  <tr class="info">
    <td colspan="20"><span class="label label-info">Visits/day</span>
      <span class="badge"><%= count_visit_per_day %></span>

      <% if ["neverstarted"].include?(state) %>
          <span class="label label-success">Total adwords not found</span>
          <span class="badge"><%= count_advert_tracking %></span>
          <span class="label label-success">Ratio Success</span>
          <span class="badge"><%= count_visit_per_day == 0 ? 0 : ((count_adword_click + count_advert_tracking) * 100 / Visit.plan_today(prev_date).count).to_i %>
            %</span>
      <% end %>
      <% if ["success", "fail", "overttl"].include?(state) %>

          <span class="label label-info">Total Adwords click</span>
          <span class="badge"><%= count_adword_click %></span>
          <span class="label label-success">Ratio Success</span>
          <span class="badge"><%= count_visit_per_day == 0 ? 0 : ((count_adword_click + count_advert_tracking) * 100 / Visit.plan_today(prev_date).count).to_i %>
            %</span>

          <span class="label label-danger">Total Captcha Submitting</span>
          <span class="badge"><%= count_captcha_submitting %></span>

      <% end %>
    </td>
  </tr>
  </tbody>
</table>